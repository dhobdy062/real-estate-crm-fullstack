<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real Estate CRM - Notifications Example</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    h1 {
      margin: 0;
      font-size: 24px;
      color: #333;
    }
    
    .notification-icon {
      position: relative;
      cursor: pointer;
    }
    
    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: #f44336;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: none;
      font-size: 12px;
      text-align: center;
      line-height: 18px;
    }
    
    .notification-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .notification-item {
      padding: 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    
    .notification-item:hover {
      background-color: #f9f9f9;
    }
    
    .notification-item.unread {
      background-color: #e8f4fd;
    }
    
    .notification-message {
      margin-bottom: 5px;
      color: #333;
    }
    
    .notification-time {
      font-size: 12px;
      color: #999;
    }
    
    .actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    
    button {
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    .login-section {
      margin-bottom: 20px;
    }
    
    input {
      padding: 8px;
      margin-right: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .status {
      margin-top: 10px;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Real Estate CRM - Notifications</h1>
      <div class="notification-icon">
        <span>ðŸ””</span>
        <span id="notification-badge" class="notification-badge">0</span>
      </div>
    </header>
    
    <div class="login-section">
      <h2>Login</h2>
      <div>
        <input type="email" id="email" placeholder="Email" value="admin@example.com">
        <input type="password" id="password" placeholder="Password" value="admin123">
        <button id="login-btn">Login</button>
      </div>
      <div class="status" id="login-status"></div>
    </div>
    
    <h2>Notifications</h2>
    <div class="notification-list" id="notification-list">
      <!-- Notifications will be added here -->
      <div class="notification-item">
        <div class="notification-message">Welcome to the Real Estate CRM notification system example.</div>
        <div class="notification-time">Just now</div>
      </div>
    </div>
    
    <div class="actions">
      <button id="mark-all-read-btn">Mark All as Read</button>
      <button id="delete-all-btn">Delete All</button>
      <button id="simulate-btn">Simulate New Notification</button>
    </div>
    
    <div class="status" id="connection-status">Not connected</div>
  </div>
  
  <script>
    // API base URL
    const API_BASE_URL = 'http://localhost:3000/api';
    
    // Store JWT token
    let token = localStorage.getItem('token');
    let socket = null;
    
    // DOM elements
    const loginBtn = document.getElementById('login-btn');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginStatus = document.getElementById('login-status');
    const connectionStatus = document.getElementById('connection-status');
    const notificationList = document.getElementById('notification-list');
    const notificationBadge = document.getElementById('notification-badge');
    const markAllReadBtn = document.getElementById('mark-all-read-btn');
    const deleteAllBtn = document.getElementById('delete-all-btn');
    const simulateBtn = document.getElementById('simulate-btn');
    
    // Login function
    async function login() {
      try {
        const response = await fetch(`${API_BASE_URL}/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: emailInput.value,
            password: passwordInput.value,
          }),
        });
        
        const data = await response.json();
        
        if (response.ok) {
          token = data.data.token;
          localStorage.setItem('token', token);
          loginStatus.textContent = `Logged in as ${data.data.user.email}`;
          
          // Connect to WebSocket
          connectToNotificationSocket();
          
          // Load notifications
          loadNotifications();
        } else {
          loginStatus.textContent = `Error: ${data.message}`;
        }
      } catch (error) {
        loginStatus.textContent = `Error: ${error.message}`;
      }
    }
    
    // Load notifications
    async function loadNotifications() {
      try {
        const response = await fetch(`${API_BASE_URL}/notifications`, {
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // Clear existing notifications
          notificationList.innerHTML = '';
          
          // Add notifications
          data.data.notifications.forEach(notification => {
            displayNotification(notification);
          });
          
          // Update unread count
          updateUnreadBadge(data.data.unread_count);
        } else {
          connectionStatus.textContent = `Error loading notifications: ${data.message}`;
        }
      } catch (error) {
        connectionStatus.textContent = `Error loading notifications: ${error.message}`;
      }
    }
    
    // Mark all notifications as read
    async function markAllAsRead() {
      try {
        const response = await fetch(`${API_BASE_URL}/notifications/read-all`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // Update UI
          document.querySelectorAll('.notification-item.unread').forEach(item => {
            item.classList.remove('unread');
          });
          
          // Update unread count
          updateUnreadBadge(0);
          
          connectionStatus.textContent = 'All notifications marked as read';
        } else {
          connectionStatus.textContent = `Error: ${data.message}`;
        }
      } catch (error) {
        connectionStatus.textContent = `Error: ${error.message}`;
      }
    }
    
    // Delete all notifications
    async function deleteAllNotifications() {
      try {
        const response = await fetch(`${API_BASE_URL}/notifications`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // Clear notification list
          notificationList.innerHTML = '';
          
          // Update unread count
          updateUnreadBadge(0);
          
          connectionStatus.textContent = 'All notifications deleted';
        } else {
          connectionStatus.textContent = `Error: ${data.message}`;
        }
      } catch (error) {
        connectionStatus.textContent = `Error: ${error.message}`;
      }
    }
    
    // Simulate a new notification (for testing)
    async function simulateNotification() {
      try {
        // This is just a simulation - in a real app, notifications would come from the server
        // based on real events like new leads, tasks, etc.
        const mockNotification = {
          id: Date.now(),
          message: `Simulated notification at ${new Date().toLocaleTimeString()}`,
          notification_type: 'Simulated',
          is_read: false,
          created_at: new Date().toISOString(),
        };
        
        // Display the notification
        displayNotification(mockNotification);
        
        // Update unread count
        const currentCount = parseInt(notificationBadge.textContent) || 0;
        updateUnreadBadge(currentCount + 1);
        
        connectionStatus.textContent = 'Simulated notification created';
      } catch (error) {
        connectionStatus.textContent = `Error: ${error.message}`;
      }
    }
    
    // Function to connect to the notification WebSocket
    function connectToNotificationSocket() {
      if (!token) {
        connectionStatus.textContent = 'Not logged in';
        return;
      }
      
      // Close existing connection if any
      if (socket) {
        socket.close();
      }
      
      // Create WebSocket connection
      socket = new WebSocket(`ws://localhost:3000/ws?token=${token}`);
      
      // Connection opened
      socket.addEventListener('open', (event) => {
        connectionStatus.textContent = 'Connected to notification server';
        
        // Send a ping message every 30 seconds to keep the connection alive
        setInterval(() => {
          if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type: 'ping' }));
          }
        }, 30000);
      });
      
      // Listen for messages
      socket.addEventListener('message', (event) => {
        try {
          const data = JSON.parse(event.data);
          
          switch (data.type) {
            case 'notification':
              // Handle new notification
              connectionStatus.textContent = `New notification received: ${data.data.message}`;
              displayNotification(data.data);
              break;
            
            case 'unread_count':
              // Update unread count badge
              connectionStatus.textContent = `Unread count updated: ${data.data.count}`;
              updateUnreadBadge(data.data.count);
              break;
            
            case 'pong':
              // Ping response, do nothing
              break;
            
            default:
              connectionStatus.textContent = `Unknown message type: ${data.type}`;
          }
        } catch (error) {
          connectionStatus.textContent = `Error parsing WebSocket message: ${error.message}`;
        }
      });
      
      // Connection closed
      socket.addEventListener('close', (event) => {
        connectionStatus.textContent = `Disconnected from notification server: ${event.code} ${event.reason}`;
        
        // Attempt to reconnect after a delay if the connection was closed unexpectedly
        if (event.code !== 1000) {
          setTimeout(() => {
            connectionStatus.textContent = 'Attempting to reconnect...';
            connectToNotificationSocket();
          }, 5000);
        }
      });
      
      // Connection error
      socket.addEventListener('error', (event) => {
        connectionStatus.textContent = `WebSocket error`;
      });
    }
    
    // Function to display a notification
    function displayNotification(notification) {
      const notificationElement = document.createElement('div');
      notificationElement.className = 'notification-item' + (notification.is_read ? '' : ' unread');
      notificationElement.innerHTML = `
        <div class="notification-message">${notification.message}</div>
        <div class="notification-time">${new Date(notification.created_at).toLocaleTimeString()}</div>
      `;
      
      // Add click handler to mark as read
      notificationElement.addEventListener('click', () => {
        if (!notification.is_read) {
          markNotificationAsRead(notification.id, notificationElement);
        }
      });
      
      notificationList.prepend(notificationElement);
    }
    
    // Function to mark a notification as read
    async function markNotificationAsRead(id, element) {
      try {
        const response = await fetch(`${API_BASE_URL}/notifications/${id}/read`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // Update UI
          element.classList.remove('unread');
          
          // Update unread count
          updateUnreadBadge(data.data.unread_count);
        } else {
          connectionStatus.textContent = `Error: ${data.message}`;
        }
      } catch (error) {
        connectionStatus.textContent = `Error: ${error.message}`;
      }
    }
    
    // Function to update the unread notification badge
    function updateUnreadBadge(count) {
      if (count > 0) {
        notificationBadge.textContent = count;
        notificationBadge.style.display = 'block';
      } else {
        notificationBadge.style.display = 'none';
      }
    }
    
    // Event listeners
    loginBtn.addEventListener('click', login);
    markAllReadBtn.addEventListener('click', markAllAsRead);
    deleteAllBtn.addEventListener('click', deleteAllNotifications);
    simulateBtn.addEventListener('click', simulateNotification);
    
    // Initialize
    if (token) {
      connectToNotificationSocket();
      loadNotifications();
    }
  </script>
</body>
</html>
